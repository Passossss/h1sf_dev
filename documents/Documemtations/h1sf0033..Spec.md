# H1SF0033 - Electronic Invoice Auxiliary Document (DANFE) and Dispatch Protocols

## Program Identification

| **Field** | **Value** |
|-----------|-----------|
| **Program ID** | H1SF0033 |
| **Author** | Alex C. Andreatta |
| **Creation Date** | 23/08/2000 |
| **Billing Phase** | Phase 4 |

## ⚠️ Important Warnings

- **Critical**: Due to special PCL printing characters, this program must be edited **ONLY** in WinSCP's native editor
- **Restriction**: **CANNOT** be modified or saved in UltraEdit, as it may cause errors in billing document printing

## Main Objective
Assembly of Fiscal DANFEs (Electronic Invoice Auxiliary Documents) and Dispatch Protocols for the billing system.

## Architecture and Program Sections

### Central Processing Sections

| Section | Author | Description |
|---------|--------|-------------|
| 000-00-ROTINA-PRINCIPAL | A.C. Andreatta | Controls main program flow |

### Preparation Sections

| Section | Author | Description |
|---------|--------|-------------|
| 100-00-PROCESSAMENTO-LOGICO | A.C. Andreatta | Central logical processing |
| 110-00-PESQUISA-SUB-TRIB | A.C. Andreatta | Tax substitution research |
| 120-00-DEFINE-IMPRESSORAS | A.C. Andreatta | Defines printers for issuance |
| 130/135-00-DEFINE-PJL-OUTBIN-S | A.C. Andreatta/E. Frioli Jr. | Defines PJL orientation |
| 140/145-00-DEFINE-PJL-OUTBIN-P | A.C. Andreatta/E. Frioli Jr. | Defines PJL orientation |
| 150-00-PESQUISA-INCENTIVO | A.C. Andreatta | Tax incentive research |
| 160-00-VERIFICA-SE-PECA-REMAN | P.F. Neto | Verifies if part is remanufactured |
| 170-00-DEFINE-VIAS-ORDENACAO | E. Frioli Jr. | Defines report copies and ordering |
| 180-00-DEFINE-VIA-IMPRESS | E. Frioli Jr. | Defines print copy number |

### I/O (Input/Output) Sections

| Section | Author | Description |
|---------|--------|-------------|
| 500-00-LE-PROTOCOLO | A.C. Andreatta | Retrieves protocols |
| 505-00-RECUPERA-EMITENTE | E. Frioli Jr. | Retrieves issuer data |
| 510-00-RECUPERA-DATA-HORA | A.C. Andreatta | Retrieves date and time |
| 520-00-RECUPERA-CLAS-FISCAL | A.C. Andreatta | Retrieves fiscal class |
| 525-00-RECUPERA-CLAS-INCENTIVO | A.C. Andreatta | Retrieves incentive class |
| 530-00-RECUPERA-PARAMETRO | A.C. Andreatta | Retrieves parameters |
| 532-00-RECUPERA-ITEM-RCBM | A.C. Andreatta | Retrieves collection items |
| 533-00-RECUPERA-CONTA-CT | A.C. Andreatta | Retrieves accounting accounts |
| 535-00-ATUALIZA-PWS | A.C. Andreatta | Updates PWS |
| 537-00-FINALIZA-ITEM-REC-PEND | E. Frioli Jr. | Finalizes pending receipt items |
| 540-00-ATUALIZA-PROTOCOLO | A.C. Andreatta | Updates protocols |
| 542-00-GRAVA-LANCAMENTOS-CT | A.C. Andreatta | Records accounting entries |
| 545-00-GRAVA-DETALHE-REL | A.C. Andreatta | Records report details |
| 546-00-INSERT-DETALHE | A.C. Andreatta | Inserts details |
| 550-00-GRAVA-RESUMO-REL | A.C. Andreatta | Records report summary |
| 555-00-GRAVA-MENSAGEM-MQ | A.C. Andreatta | Records MQ message |
| 560-00-ATUALIZA-MONITOR | A.C. Andreatta | Updates monitor |
| 565-00-ATUALIZA-LBRC-IMPS | E. Frioli Jr. | Updates LBRC_IMPS |
| 567-00-ATUALIZA-ODA-CMIS2 | E. Frioli Jr. | Updates ODA_CMIS2 |
| 570-00-RETRIEVE-PARAMETRO | A.C. Andreatta | Retrieves parameters |
| 572-00-SQL-RECUPERA-CNPJ | E. Frioli Jr. | Retrieves CNPJ via SQL |
| 573-00-ENTRADA-NF-IC-RIS | E. Frioli Jr. | NF IC RIS entry |
| 575-00-EMITE-LINK-H1CB5026 | A.C. Andreatta | Interface with H1CB5026 |
| 580-00-EMITE-LINK-H1CB5010 | A.C. Andreatta | Interface with H1CB5010 |
| 581-00-EMITE-LINK-H1CB5035 | P.F. Neto | Interface with H1CB5035 |
| 582-00-EMITE-LINK-H1SF5049 | E. Frioli Jr. | Interface with H1SF5049 |
| 583-00-EMITE-LINK-H1SF5053 | E. Frioli Jr. | Interface with H1SF5053 |
| 584-00-EMITE-LINK-H1SF5008-02 | E. Frioli Jr. | Interface with H1SF5008-02 |
| 585-00-EMITE-ROLLBACK | A.C. Andreatta | Executes rollback |
| 590-00-EMITE-SYNCPOINT | A.C. Andreatta | Executes syncpoint |
| 595-00-EMITE-RETURN-CICS | A.C. Andreatta | Returns to CICS |
| 600/605/607-00-VERIFICA-DELTA/CME/DEA | A.C. Andreatta | Various verifications |
| 610/615-00-GETMAIN/FREEMAIN-TRSC | A.C. Andreatta | Memory management |
| 620-00-GRAVA-INTERFACE-DEA | A.C. Andreatta | Records DEA interface |
| 625-00-START-SF30-FASE2 | E. Frioli Jr. | Starts SF30 Phase 2 |
| 630/635-00-EMITE/LIBERA-ENQ-CONTROLE | E. Frioli Jr. | Enqueue control |
| 640-00-EMITE-DELAY | E. Frioli Jr. | Executes delay |
| 645-00-START-SF31 | E. Frioli Jr. | Starts SF31 |

### Movement Sections

| Section | Author | Description |
|---------|--------|-------------|
| 700-00-TRATA-PROTOCOLO | A.C. Andreatta | Protocol handling |
| 705-00-MONTA-DANFE | E. Frioli Jr. | DANFE assembly |
| 710-00-MONTA-PROTOCOLO | A.C. Andreatta | Protocol assembly |
| 715-00-MONTA-CORPO-PROTOCOLO | A.C. Andreatta | Protocol body assembly |
| 720/725-00-MONTA-PCK-LIST | E. Frioli Jr. | Packing list assembly |
| 730/735-00-MONTA-PCK-LIST-RES | E. Frioli Jr. | Packing list summary assembly |
| 740-00-PCL-DETALHE | E. Frioli Jr. | PCL detail |
| 745-00-PCL-DANFE | E. Frioli Jr. | PCL DANFE |
| 746-00-CALCULA-LINHAS-DANFE | E. Frioli Jr. | Calculates DANFE lines |
| 747-00-TRATA-QUEBRA-PAGINA | E. Frioli Jr. | Handles page break |
| 750-00-PREPARA-DETALHE-DANFE | E. Frioli Jr. | Prepares DANFE detail |
| 755/756-00-PREPARA-DETALHE-PTD/INST | A.C. Andreatta | Prepares details |
| 757-00-PREPARA-DETALHE-PCK-LST | E. Frioli Jr. | Prepares packing list detail |
| 760-00-PREPARA-RESUMO-DANFE | E. Frioli Jr. | Prepares DANFE summary |
| 765/766-00-PREPARA-RESUMO-PTD/INST | A.C. Andreatta | Prepares summaries |
| 767-00-PREPARA-RESUMO-PCK-LST | E. Frioli Jr. | Prepares packing list summary |
| 770/780-00-TROCA-PONTO | A.C. Andreatta | Decimal point handling |
| 790/791-00-MONTA-LOG-NF | A.C. Andreatta | NF log assembly |
| 795-00-MONTA-LOG-PROTOCOLO | A.C. Andreatta | Protocol log assembly |
| 800-00-DESCARREGA-VIAS-DANFE | E. Frioli Jr. | DANFE copies discharge |
| 805-00-GRAVA-TAB-DANFE | E. Frioli Jr. | Records DANFE table |
| 810-00-DESCARREGA-VIAS-PTD | A.C. Andreatta | Protocol copies discharge |
| 815-00-GRAVA-TAB-PTD | A.C. Andreatta | Records protocol table |
| 820-00-DESCARREGA-VIAS-PCK-LST | E. Frioli Jr. | Packing list copies discharge |
| 825-00-GRAVA-TAB-PCK-LST | E. Frioli Jr. | Records packing list table |
| 830-00-INTERFACE-SAP-DADOS-EXP | C.O. Carvalho | SAP export data interface |
| 840-00-GERA-LANCAMENTOS-CT | A.C. Andreatta | Generates accounting entries |
| 845-00-CONTABILIZA-ITEM | A.C. Andreatta | Accounts for item |
| 850-00-CONTABILIZA-DANFE | A.C. Andreatta | Accounts for DANFE |
| 855/860-00-INTERFACE-CME | A.C. Andreatta | CME interface |
| 865/870-00-INTERFACE-DEA | A.C. Andreatta | DEA interface |
| 875-00-MONTA-LOG-CAPS | E. Frioli Jr. | CAPS log assembly |
| 880/885-00-INTERFACE-S-DE | E. Frioli Jr. | S-DE interface |
| 890/895-00-INTERFACE-EXP-CTRL | E. Frioli Jr. | Export control interface |

### Complementary Sections

| Section | Author | Description |
|---------|--------|-------------|
| 900-00-REGISTRA-ERRO-TRNS | A.C. Andreatta | Error logging |
| 910-00-TIPO-PEDIDO | A.C. Andreatta | Defines order type |
| 920-00-MONTA-COD-BARRA | A.C. Andreatta | Barcode assembly |
| 930-00-MONTA-COD-BARRA-PRT | E. Frioli Jr. | Protocol barcode assembly |
| 940-00-CONVERTE-UF | A.C. Andreatta | State code conversion |
| 950-00-MENSAGENS-LEGAIS | E. Frioli Jr. | Legal messages |
| 960-00-INSTRUCAO-ESPECIAL | A.C. Andreatta | Special instructions |

## Identified Business Rules

### 1. Print Control
- **Automatic printer selection** based on service type and region
- **PJL command support** for orientation and output control
- **Multiple copy definition** for different documents (DANFE, Protocol, Packing List)

### 2. Taxation and Fiscal
- **Tax substitution research** by fiscal class
- **Tax incentive verification**
- **Tax calculations** (ICMS, IPI, PIS, COFINS)
- **Special regime control** (In Company BT Nationalization)

### 3. Fiscal Documents
- **DANFE generation** (Electronic Invoice Auxiliary Document)
- **Dispatch protocol issuance**
- **Packing list generation** for export
- **NFe contingency support**

### 4. Integrations
- **SAP system interface** for export data
- **Integration with CME and DEA systems**
- **MQ Series communication**
- **Interface with accounting modules**

### 5. Specific Controls
- **Remanufactured parts verification**
- **Volume and packing list control**
- **Multiple transport mode management** (1-6)
- **Export operations support**

### 6. Security and Validations
- **CICS access control**
- **Error handling and transactional rollback**
- **Fiscal data validation**
- **Concurrency control** via ENQ/DEQ

## Main Data Structures

### Included SQL Tables

| Table | Description |
|-------|-------------|
| H1SF.PTD_PROTODSP | Dispatch protocols |
| H1SF.ITD_ITMFATURADO | Billed items |
| H1SF.TPT_TRANSPORTADORA | Carriers |
| H1SF.SUF_SUFRAMA | SUFRAMA data |
| H1SF.SFT_SELECAO_FTRM | Billing selection |
| H1SF.CTB_LANCAMENTOS | Accounting entries |
| H1SF.CLS_CLASSE_FISCAL | Fiscal classes |

## Technical Considerations

- **Embedded SQL** for database access
- **Robust error handling** with SQLCODE and CICS
- **PCL format printing** with special characters
- **Dynamic memory management** with GETMAIN/FREEMAIN
- **CICS transactions** with SYNCPOINT/ROLLBACK

## Main Flow

```mermaid
graph TD
    A[Initialization & Parameter Retrieval] --> B[Printer & Configuration Definition]
    B --> C[Issuer & CNPJ Data Retrieval]
    C --> D[Protocol & Document Processing]
    D --> E[DANFE & Auxiliary Document Assembly]
    E --> F[External System Interfaces]
    F --> G[Finalization & Transactional Commit]